<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Simple BlockMirror Example</title>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
            crossorigin="anonymous"></script>

    <!-- Blockly -->
    <script src="../../blockly/blockly_compressed.js" type="text/javascript"></script>
    <script src="../../blockly/blocks_compressed.js" type="text/javascript"></script>
    <script src="../../blockly/msg/js/en.js" type="text/javascript"></script>
    <script src="../../blockly/python_compressed.js" type="text/javascript"></script>

    <!-- CodeMirror -->
    <link rel="stylesheet" href="../lib/codemirror/codemirror.css">
    <script src="../lib/codemirror/codemirror.js" type="text/javascript"></script>
    <script src="../lib/codemirror/python.js" type="text/javascript"></script>

    <!-- Skulpt -->
    <script src="../../skulpt/dist/skulpt.js" type="text/javascript"></script>
    <script src="../../skulpt/dist/skulpt-stdlib.js" type="text/javascript"></script>

    <!-- BlockMirror -->
    <link rel="stylesheet" href="../src/block_mirror.css">
    <script src="../src/blockly_shims.js" type="text/javascript"></script>
    <script src="../src/block_mirror.js" type="text/javascript"></script>
    <script src="../src/text_editor.js" type="text/javascript"></script>
    <script src="../src/block_editor.js" type="text/javascript"></script>
    <script src="../src/text_to_blocks.js" type="text/javascript"></script>

    <script src="../src/ast/ast_For.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Num.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Expr.js" type="text/javascript"></script>
    <script src="../src/ast/ast_BinOp.js" type="text/javascript"></script>

</head>
<body>
<button id='go'>GO</button>
<div style="width:900px; margin:0 auto;"
     id='example-frame'>

    <div class="btn-group" data-toggle="buttons" data-bind="visible: !assignment.upload()">
        <label onclick="editor.setMode('block');">
            <input type="radio" name="blockpy-mode-set" autocomplete="off"> Blocks
        </label>
        <label onclick="editor.setMode('split');">
            <input type="radio" name="blockpy-mode-set" autocomplete="off" checked> Split
        </label>
        <label onclick="editor.setMode('text');">
            <input type="radio" name="blockpy-mode-set" autocomplete="off"> Text
        </label>
    </div>


    <div id="blockmirror-editor"></div>
</div>


<script type="text/javascript">
    var editor = new BlockMirror({
        'container': document.getElementById('blockmirror-editor'),
    });
    editor.setCode('__main__', 'a = 0\nb=0\nprint(b)');
    editor.addChangeListener(function (event) {
        console.log('Change! Better save:', event)
    });

    $('#go').click(function () {
        alert('Starting!')
        Sk.configure({
            __future__: Sk.python3,
            read: function (filename) {
                if (Sk.builtinFiles === undefined ||
                    Sk.builtinFiles["files"][filename] === undefined) {
                    throw "File not found: '" + filename + "'";
                }
                return Sk.builtinFiles["files"][filename];
            }
        });
        var filename = 'main';
        var code = `import pedal`;
        //console.time('Run');
        Sk.importMainWithBody(filename, false, code, true).$d;
        //console.timeEnd('Run');
        alert('Done!')
    });

    var TESTS = [
        'for ___ in ___:\n    pass',
        '0',
        '0\n0\n0\n0\n',
        'for ___ in ___:\n    0\n    0',
        '1 + 1',
        '1 * 3 + 4 + 6 & 8'
    ]

    for (var i = 0; i < TESTS.length; i += 1) {
        var test = TESTS[i];
        editor.textEditor.setCode('__main__.py', test);
        editor.blockEditor.setText(editor.textEditor.getCode())
        editor.blockEditor.setText(editor.textEditor.getCode())
        if (test != editor.textEditor.getCode()) {
            console.error("Test failure", test, editor.textEditor.getCode());
        }
    }
</script>
</body>
</html>