<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Simple BlockMirror Example</title>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
            crossorigin="anonymous"></script>

    <!-- Blockly -->
    <script src="../../blockly/blockly_compressed.js" type="text/javascript"></script>
    <script src="../../blockly/blocks_compressed.js" type="text/javascript"></script>
    <script src="../../blockly/msg/js/en.js" type="text/javascript"></script>
    <script src="../../blockly/python_compressed.js" type="text/javascript"></script>

    <!-- CodeMirror -->
    <link rel="stylesheet" href="../lib/codemirror/codemirror.css">
    <script src="../lib/codemirror/codemirror.js" type="text/javascript"></script>
    <script src="../lib/codemirror/python.js" type="text/javascript"></script>

    <!-- Skulpt -->
    <script src="../../skulpt/dist/skulpt.js" type="text/javascript"></script>
    <script src="../../skulpt/dist/skulpt-stdlib.js" type="text/javascript"></script>

    <!-- BlockMirror -->
    <link rel="stylesheet" href="../src/block_mirror.css">
    <script src="../src/blockly_shims.js" type="text/javascript"></script>
    <script src="../src/block_mirror.js" type="text/javascript"></script>
    <script src="../src/text_editor.js" type="text/javascript"></script>
    <script src="../src/block_editor.js" type="text/javascript"></script>
    <script src="../src/text_to_blocks.js" type="text/javascript"></script>

    <script src="../src/ast/ast_For.js" type="text/javascript"></script>
    <script src="../src/ast/ast_If.js" type="text/javascript"></script>
    <script src="../src/ast/ast_While.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Num.js" type="text/javascript"></script>
    <script src="../src/ast/ast_BinOp.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Name.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Assign.js" type="text/javascript"></script>
    <script src="../src/ast/ast_AnnAssign.js" type="text/javascript"></script>
    <script src="../src/ast/ast_AugAssign.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Str.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Expr.js" type="text/javascript"></script>
    <script src="../src/ast/ast_UnaryOp.js" type="text/javascript"></script>
    <script src="../src/ast/ast_BoolOp.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Compare.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Assert.js" type="text/javascript"></script>
    <script src="../src/ast/ast_NameConstant.js" type="text/javascript"></script>
    <script src="../src/ast/ast_List.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Tuple.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Set.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Dict.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Starred.js" type="text/javascript"></script>
    <script src="../src/ast/ast_IfExp.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Attribute.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Call.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Raise.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Delete.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Subscript.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Comp.js" type="text/javascript"></script>
    <script src="../src/ast/ast_FunctionDef.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Lambda.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Return.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Yield.js" type="text/javascript"></script>
    <script src="../src/ast/ast_YieldFrom.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Global.js" type="text/javascript"></script>
    <!--<script src="../src/ast/ast_Nonlocal.js" type="text/javascript"></script>-->
    <script src="../src/ast/ast_Break.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Continue.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Try.js" type="text/javascript"></script>
    <script src="../src/ast/ast_ClassDef.js" type="text/javascript"></script>
    <script src="../src/ast/ast_Import.js" type="text/javascript"></script>
    <script src="../src/ast/ast_With.js" type="text/javascript"></script>

</head>
<body>
<button id='go'>GO</button>
<div style="width:900px; margin:0 auto;"
     id='example-frame'>

    <div class="btn-group" data-toggle="buttons" data-bind="visible: !assignment.upload()">
        <label onclick="editor.setMode('block');">
            <input type="radio" name="blockpy-mode-set" autocomplete="off"> Blocks
        </label>
        <label onclick="editor.setMode('split');">
            <input type="radio" name="blockpy-mode-set" autocomplete="off" checked> Split
        </label>
        <label onclick="editor.setMode('text');">
            <input type="radio" name="blockpy-mode-set" autocomplete="off"> Text
        </label>
    </div>


    <div id="blockmirror-editor"></div>
</div>


<script type="text/javascript">
    var editor = new BlockMirror({
        'container': document.getElementById('blockmirror-editor'),
    });
    editor.setCode('__main__', 'a = 0\nb=0\nprint(b)');
    editor.addChangeListener(function (event) {
        console.log('Change! Better save:', event)
    });

    Sk.configure({
        __future__: Sk.python3,
        read: function (filename) {
            if (Sk.builtinFiles === undefined ||
                Sk.builtinFiles["files"][filename] === undefined) {
                throw "File not found: '" + filename + "'";
            }
            return Sk.builtinFiles["files"][filename];
        }
    });

    $('#go').click(function () {
        alert('Starting!')
        var filename = 'main';
        var code = `import pedal`;
        //console.time('Run');
        Sk.importMainWithBody(filename, false, code, true).$d;
        //console.timeEnd('Run');
        alert('Done!')
    });

    var TESTS = [
        'for ___ in ___:\n    pass',
        '0',
        '0\n0\n0\n0\n',
        'for ___ in ___:\n    0\n    0',
        'for x in y:\n    pass',
        '1 + 1',
        '(1 * 3 + 4) + 6 & 8',
        '(1 + 2) - (3 * 4) / 5 | 7 & (8 % 9 << 10) >> 11 // 12',
        'not 4',
        '+1\n-2\n~4\nnot 5\nnot not not 4',
        '1 or 2',
        '1 and 2 and 3 or 4 and 5 or 3 or 4',
        '1 < 5',
        '(2 < 3) < 4',
        '(((4 > 3) < 2) > 2) < 2',
        '5 is 4',
        '___ in ___',
        '3 is not 4',
        '(1 is 2) is 3',
        '(((((((1 == 2) != 3) <= 4) >= 5) in 3) not in 3) is 4) is not 5',
        '1 < 2 and 3 < 4',
        'assert (1 < 2)',
        'assert (1 > 4), ___',
        '"Hello \'world.\'"',
        "'Hello \"there.\"'",
        'alpha\nbeta\ngamma',
        'alpha\nalpha\nalpha',
        'True\nFalse\nNone',
        '[]\n[1, 2, 3]\n[1, 2, 4, 5]\n()\n(1, 2, 3)\n(1, 2)\n(1, )\n(1, 2, 3, 4, 5)',
        '{1, 2, 3}\n{1}\n{4, 5, 6, 7}',
        "{1: 2, 'Hello': 'World'}\n{}",
        '{*{}}',
        "0 if True else False",
        "dog.growl\nalpha.beta.gamma\n'Test'.save",
        'alpha\nalpha(1)\nbeta(2)\nbeta',
        'alpha(beta)\nalpha.beta(gamma)\nhello(1, 2, 3)\nfor a in b:\n    (corgi(run))',
        'sorted([1, 2, 3], reverse=True)',
        'complex(1, 2, *first, *second, **big, **dog, third=3, fourth=4)',
        "raise\nraise Exception()\nraise Exception() from wherever",
        "del alpha\ndel alpha, beta, gamma",
        "simple[0]\nranged[1:2]\nranged[:2]\nranged[1:]\nranged[:]",
        "ranged[::3]\nranged[1::3]\nranged[:2:3]\nranged[1:2:3]",
        // acbart: This ends up the same as [:], so can't test it.
        // "r[::]"
        "df[1:2, 4]\ndf[1, 2, 3, 4]\ndf[6::7, 4:6, 5, 1:]",
        "[x for a in b if c]\n[x for a in b for c in d if e if g]",
        "{x for a in b if c}\n{x for a in b for c in d if e if g}",
        "(x for a in b if c)\n(x for a in b for c in d if e if g)",
        "{x: y for a in b if c}\n{x: y for a in b for c in d if e if g}",
        "a = 0\na = b = c = 0",
        "(a, b) = (1, 2)\n[x, (y, z)] = something",
        "i: int = 0\ns: str = 'Hello'\nf: float = 4.3\nb: bool = True\nx: X = 4",
        "i: 'int' = 0\ns: 'str' = 'Hello'\nf: 'float' = 4.3\nb: 'bool' = True",
        "n: None = None\na[0]: List[int] = 0\nb: Dict[str, str]",
        'a += 1\nb *= 4\nc **= 4\nd ^= 10',
        `def alpha(beta, gamma, delta):\n    pass`,
        `def alpha(beta: str, gamma=True, delta: int=0):\n    pass`,
        `@route\n@open('test')\ndef alpha(beta: str, gamma=True, delta: int=0):\n    pass`,
        `@route\n@open('test')\ndef alpha(beta: str, gamma=True, delta: int=0, *args, k=4, num: int=3, **kwargs):\n    a = 0\n    b = 7`,
        "def do_something(a: int) -> str:\n    assert (4 == 3)",
        'lambda x, y=0: x + y',
        "def simple(a, b, c) -> int:\n    return 'Hello world!'\n    return",
        "def simple(a, b, c) -> int:\n    (yield 'Hello world!')\n    (yield)\n    dog = yield b + 4",
        "def simple(a, b, c) -> int:\n    (yield from 'Hello world!')\n    dog = yield from b + 4",
        "def simple(a, b, c) -> int:\n    global alpha\ndef another(e, f):\n    global alpha, beta, gamma",
        //"def simple(a, b, c) -> int:\n    def inner():\n        nonlocal alpha\n        nonlocal alpha, beta, gamma",
        "for x in y:\n    break\n    continue",
        ("try:\n    pass\nexcept NameError:\n    pass" +
            "\nexcept Something() as other:\n    pass\n" +
            "except None as some:\n    pass\nexcept:\n    " +
            "pass\nelse:\n    pass\nfinally:\n    pass"),
        "try:\n    a = 0\nexcept:\n    return",
        "@whatever\nclass a(b, *d, c=0, **e):\n    a = 0\nclass Dog:\n    age = 1\n    name = 'Ada'",
        "if x:\n    pass\nif y:\n    pass\nelse:\n    pass",
        "if a:\n    if j:\n        pass\n    elif k:\n        pass\n    else:\n        pass\nelif b:\n    pass",
        "while x == 0:\n    pass\nwhile y < z:\n    a = 0\nelse:\n    b = a",
        "import x as y, b as c, d\nimport os",
        "from . import x\nfrom .os import y\nfrom ..path import z\nfrom dog.house import a\nfrom cat import b, c as d, e",
        "import matplotlib.pyplot as plt",
        "with open('filename') as outfile:\n    pass",
        "with open('filename') as outfile, open('file2') as infile, other_context:\n    pass",
    ];

    for (var i = 0; i < TESTS.length; i += 1) {
        var test = TESTS[i];
        editor.textEditor.setCode('__main__.py', test);
        editor.blockEditor.setText(editor.textEditor.getCode())
        editor.blockEditor.changed();
        editor.blockEditor.workspace.cleanUp();
        console.assert(test.trim() === editor.textEditor.getCode().trim(),
            "\nExpected:\n" + test.trim() + "\n",
            "\nActual:\n" + editor.textEditor.getCode().trim() + "\n");
        if (test.trim() !== editor.textEditor.getCode().trim()) {
            break;
        }
        editor.blockEditor.setText(editor.textEditor.getCode())
        editor.blockEditor.changed();
        editor.blockEditor.workspace.cleanUp();
        console.assert(test.trim() === editor.textEditor.getCode().trim(),
            "\nExpected:\n" + test.trim() + "\n",
            "\nActual:\n" + editor.textEditor.getCode().trim() + "\n(second trip)");
        if (test.trim() !== editor.textEditor.getCode().trim()) {
            break;
        }
    }
</script>
</body>
</html>